/*
 * blinky.c
 */
#include <timer.h>
#include "main.h"
#include "digital_io.h"
#include "timer.h"
#include "app.h"

#define BUTTON_PIN GPIO_PIN_0 // Definindo o pino do botão como PA0
#define DEBOUNCE_DELAY 50 // Delay de debounce em milissegundos
#define INPUT GPIO_MODE_INPUT // Definindo o modo de entrada

volatile int duty = 0; // Declara a variável duty como global e volatile

void blinky(void) {
    if (digitalRead(0) == LOW)
        digitalWrite(0, HIGH);
    else
        digitalWrite(0, LOW);
}

void update_duty(void) {
    blinky();
}

void button_isr(void) {
    static uint32_t last_interrupt_time = 0;
    uint32_t current_time = HAL_GetTick();

    // Verifica se ocorreu debounce
    if (current_time - last_interrupt_time > DEBOUNCE_DELAY) {
        last_interrupt_time = current_time;
        duty += 5; // Incrementa o duty cycle em 5%
        if (duty > 100) {
            duty = 100; // Limita o duty cycle máximo a 100%
        }
        timer_pwm_duty(0, 1, duty);
    }
}

void setup(void) {
    pinMode(BUTTON_GPIO_Port, BUTTON_PIN, INPUT); // Corrigindo a chamada da função pinMode

    HAL_NVIC_SetPriority(EXTI0_IRQn, 0, 0); // Definindo a prioridade da interrupção do botão
    HAL_NVIC_EnableIRQ(EXTI0_IRQn); // Habilitando a interrupção do botão

    timer_attach_callback(0, update_duty);
    timer_start(0, 0);
    timer_pwm_duty(0, 1, 0);
    timer_pwm_start(0, 1, 0);
}

void loop(void) {
}
